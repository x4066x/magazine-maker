# LINE Bot with File Support

シンプルなLINE BotとOpenAI ChatGPTの統合プロジェクトです。ユーザーのメッセージに対してChatGPTが日本語で簡潔に回答し、さらにファイル受信・送信・AI生成機能も提供します。

**新機能（v3.0）**: auto-designerのPDF生成APIとの連携により、ユーザーとの対話を通じて自分史PDFを生成する機能を追加しました。

## 主な機能

### 基本機能
- **メッセージ転送**: ユーザーのメッセージをChatGPTに送信
- **短文AI回答**: ChatGPTからの簡潔な回答（1〜2文）をLINEで返信
- **エラーハンドリング**: API呼び出しエラー時の適切な処理

### 自分史作成機能（v3.0）
- **対話型データ収集**: ユーザーとの対話を通じて基本情報と年表を収集
- **画像アップロード**: 年表の各出来事に関連する画像を追加
- **PDF生成**: auto-designer APIを使用した美しい自分史PDFの生成
- **セッション管理**: ユーザーごとの作成状態を管理

### ファイル受信機能（v2.0）
- **画像受信**: JPEG、PNG、GIF画像をWebhookで受信・保存
- **動画受信**: MP4、QuickTime動画をWebhookで受信・保存
- **音声受信**: MP3、WAV、AAC音声をWebhookで受信・保存
- **ファイル受信**: PDF、ZIP、テキストファイルをWebhookで受信・保存

### ファイル送信機能（v2.0）
- **画像メッセージ**: JPEG、PNG、GIF画像の送信
- **動画メッセージ**: MP4、QuickTime動画の送信
- **音声メッセージ**: MP3、WAV、AAC音声の送信
- **ファイルメッセージ**: PDF、ZIP、テキストファイルの送信

### AI生成機能
- **レポート生成**: GPTによる詳細レポート作成
- **JSON生成**: 構造化データファイル作成
- **テキスト生成**: カスタムテキストファイル作成

## 使用コマンド

| コマンド | 機能 | 例 |
|----------|------|---|
| `自分史作成` | 自分史作成モード開始 | `自分史作成` |
| `memoir` | 自分史作成モード開始 | `memoir` |
| `キャンセル` | 自分史作成をキャンセル | `キャンセル` |
| `レポート作成: [テーマ]` | レポート生成 | `レポート作成: AIの未来について` |
| `JSON生成: [内容]` | JSON作成 | `JSON生成: ユーザー情報のサンプルデータ` |
| `ファイル一覧` | 保存ファイル表示 | `ファイル一覧` |
| `サンプル確認` | サンプルPDFファイルを送信 | `サンプル確認` |

## 自分史作成の流れ

### 1. 開始
ユーザーが「自分史作成」または「memoir」と入力

### 2. 基本情報収集
- お名前
- 生年月日
- 出身地
- 現在の職業
- 趣味
- 自己紹介

### 3. 年表作成
- 人生の重要な出来事を年別に収集
- 各出来事の詳細説明
- 関連画像のアップロード（オプション）

### 4. 確認・生成
- 収集した情報の確認
- PDF生成の実行
- 生成されたPDFの配信

### 使用例
```
ユーザー: 自分史作成
ボット: 自分史の作成を開始します！まずは基本情報を教えてください。
       お名前を教えてください。

ユーザー: 田中太郎
ボット: 田中太郎さんですね！生年月日を教えてください。
       （例：1985年3月15日）

ユーザー: 1985年3月15日
ボット: 出身地を教えてください。

ユーザー: 東京都
ボット: 現在の職業を教えてください。

ユーザー: ソフトウェアエンジニア
ボット: 趣味があれば教えてください。（複数の場合はカンマ区切りで）

ユーザー: 読書,旅行,写真撮影
ボット: 基本情報の収集が完了しました！
       次は人生の重要な出来事を年別に教えてください。
       まず、1985年の出来事を教えてください。

ユーザー: 誕生
ボット: 1985年：誕生
       この出来事について詳しく教えてください。

ユーザー: 東京都で生まれました。両親と兄の4人家族で育ちました。
ボット: 1991年の出来事を教えてください。

ユーザー: 小学校入学
ボット: 1991年：小学校入学
       この出来事について詳しく教えてください。

ユーザー: 地元の公立小学校に入学。友達と一緒に楽しく学校生活を送りました。
ボット: 他に重要な出来事があれば教えてください。
       なければ「完了」と入力してください。

ユーザー: 完了
ボット: 収集した情報を確認します：
       
       名前：田中太郎
       生年月日：1985年3月15日
       出身地：東京都
       職業：ソフトウェアエンジニア
       趣味：読書,旅行,写真撮影
       
       年表：
       - 1985年：誕生
       - 1991年：小学校入学
       
       PDFを生成しますか？（はい/いいえ）

ユーザー: はい
ボット: PDFを生成中です...しばらくお待ちください。
       
       自分史PDFが完成しました！
       ファイル名：memoir_田中太郎_20250101_120000.pdf
       ファイルURL：https://your-domain.com/files/abc123...
```

## セットアップ

### 1. プロジェクトのクローン

```bash
# プロジェクトをクローン（適宜パスを調整）
cd line-bot
```

### 2. 環境変数の設定

`.env` ファイルを作成して以下の環境変数を設定：

```env
# LINE Bot設定
CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
CHANNEL_SECRET=your_line_channel_secret

# OpenAI API設定
OPENAI_API_KEY=your_openai_api_key

# サーバー設定（本番環境）
BASE_URL=https://your-domain.com

# auto-designer API設定
AUTO_DESIGNER_URL=http://localhost:3000

# 開発環境の場合
# BASE_URL=http://localhost:8000
# AUTO_DESIGNER_URL=http://localhost:3000
```

### 3. 依存関係のインストール

```bash
# uvを使用してインストール
uv sync
```

### 4. サーバーの起動

```bash
# 開発サーバーを起動
uv run python main.py
```

サーバーは `http://127.0.0.1:8000` で起動します。

## API エンドポイント

| エンドポイント | メソッド | 機能 |
|----------------|----------|------|
| `/` | GET | API情報表示 |
| `/callback` | POST | LINE Webhook受信 |
| `/files/{file_id}` | GET | ファイル配信 |
| `/api/files` | GET | ファイル一覧取得（デバッグ用） |
| `/api/files/{file_id}` | GET | ファイル情報取得（デバッグ用） |

## 外部アクセスの設定（開発時）

LINE Webhookには外部からアクセス可能なURLが必要です。Cloudflare Tunnelを使用：

```bash
# Cloudflare Tunnelで公開
cloudflared tunnel --url localhost:8000
```

出力されたURL（例：`https://example.trycloudflare.com`）をLINE Developers ConsoleのWebhook URLに設定：

```
https://example.trycloudflare.com/callback
```

**重要**: `BASE_URL`環境変数も同じURLに設定してください：

```env
BASE_URL=https://example.trycloudflare.com
```

## API Keys の取得

- **LINE Bot**: [LINE Developers Console](https://developers.line.biz/)でChannel Access TokenとChannel Secretを取得
- **OpenAI**: [OpenAI Platform](https://platform.openai.com/)でAPI Keyを取得

## 使用方法

### 基本的な会話
1. LINE BotをLINEアプリで友達追加
2. メッセージを送信
3. ChatGPTが生成した短文回答が返信される

### 自分史作成機能（新機能）
1. 「自分史作成」または「memoir」と入力
2. 対話形式で基本情報を入力
3. 人生の重要な出来事を年別に記録
4. 必要に応じて画像をアップロード
5. 確認後にPDFを生成
6. 生成された自分史PDFをダウンロード

### ファイル受信機能
1. LINE Botにファイルを送信：
   - 画像（JPEG、PNG、GIF）
   - 動画（MP4、QuickTime）
   - 音声（MP3、WAV、AAC）
   - ファイル（PDF、ZIP、TXTなど）
2. Botが自動でファイルを受信・保存
3. ファイル受信確認メッセージが返信される

### ファイル生成機能
1. 特定のコマンドを送信：
   - `レポート作成: 人工知能の現状と将来展望`
   - `JSON生成: ECサイトの商品データサンプル`
2. AIが生成したファイルがLINEで送信される
3. ファイルをタップしてダウンロード・閲覧

### ファイル管理
- `ファイル一覧` で保存されているファイルを確認
- Web API経由でファイルの管理・アクセスが可能

## サポートするファイル形式

| ファイルタイプ | 対応形式 | LINE表示 | 処理 |
|----------------|-----------|----------|------|
| 画像 | JPEG, PNG, GIF | 画像メッセージ | 受信・送信 |
| 動画 | MP4, QuickTime | 動画メッセージ | 受信・送信 |
| 音声 | MP3, WAV, AAC | 音声メッセージ | 受信・送信 |
| ファイル | PDF, ZIP, TXT, JSON | ファイルメッセージ | 受信・送信 |

## ドキュメント

詳細な設計情報とアーキテクチャについては以下を参照：

- **設計ドキュメント**: [`docs/design.md`](docs/design.md)
  - アーキテクチャ概要
  - ファイル構成と責任分離
  - データフローと主要コンポーネント
  - 自分史作成機能の詳細
  - ファイル受信・送信機能の詳細
  - 開発履歴と今後の拡張可能性

## トラブルシューティング

### よくある問題

1. **環境変数エラー**: `.env`ファイルが正しく設定されているか確認
2. **API Key エラー**: LINE・OpenAIのAPI Keyが有効か確認  
3. **Webhook エラー**: Cloudflare TunnelのURLがLINE Consoleに正しく設定されているか確認
4. **ファイル送信エラー**: `BASE_URL`が正しく設定されているか確認
5. **自分史作成エラー**: `AUTO_DESIGNER_URL`が正しく設定されているか確認
6. **ファイル受信エラー**: LINE Platform APIへのアクセス権限があるか確認

### ログの確認

サーバー起動時に環境変数の確認ログが表示されます：

```
CHANNEL_ACCESS_TOKEN: [最初の5文字]... (truncated for security)
CHANNEL_SECRET: [最初の5文字]... (truncated for security)  
OPENAI_API_KEY: [最初の5文字]... (truncated for security)
```

### 自分史作成関連のトラブル

- **対話が進まない**: セッションが正しく管理されているか確認
- **PDF生成エラー**: auto-designer APIが起動しているか確認
- **画像が追加されない**: 自分史作成モード中に画像をアップロードしているか確認

### ファイル関連のトラブル

- **ファイルが受信されない**: Webhook URLが正しく設定されているか確認
- **ファイルが保存されない**: `uploads/`ディレクトリが作成されているか確認
- **画像が表示されない**: `BASE_URL/files/{file_id}`にブラウザでアクセスできるか確認
- **ファイルサイズエラー**: LINE Messaging APIの制限（画像: 10MB, 動画: 200MB, 音声: 200MB, ファイル: 100MB）を確認

## ファイル処理の仕組み

### 受信（Webhook経由）
1. ユーザーがLINE appでファイルを送信
2. LINE PlatformがWebhookでファイルIDを通知
3. BotがLINE Platform APIでファイルをダウンロード
4. ローカルストレージに保存・確認メッセージ送信

### 送信（AI生成）
1. ユーザーがファイル生成コマンドを送信
2. OpenAI APIでファイル内容を生成
3. ローカルストレージに保存
4. LINE Messaging APIでファイルメッセージ送信

## セキュリティ考慮事項

- ファイルサイズ制限の実装
- ディレクトリトラバーサル対策
- ファイルタイプ検証
- 本番環境では適切なファイルアクセス制限を実装

## 開発

コードの構成とアーキテクチャの詳細は [`docs/design.md`](docs/design.md) を参照してください。

### ディレクトリ構造

```
line-bot/
├── main.py                 # FastAPI アプリケーション
├── handlers.py             # Webhook ハンドラー
├── line_service.py         # LINE Bot サービス（ファイル受信・送信）
├── openai_service.py       # OpenAI API サービス（ファイル生成）
├── file_service.py         # ファイル管理サービス
├── uploads/                # ファイル保存ディレクトリ
├── docs/design.md          # 設計ドキュメント
└── README.md               # このファイル
```
