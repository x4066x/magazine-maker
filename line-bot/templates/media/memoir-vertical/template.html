<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        /* ====================================
           ページサイズ定義
        ==================================== */
        /* デフォルトはA4 */
        @page {
            size: A4;
            margin: 0;
        }
        
        /* 見開きページ用 - 420mm x 297mm（A3横） */
        @page spread {
            size: 420mm 297mm;
            margin: 0;
        }
        
        /* ====================================
           共通スタイル
        ==================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            line-height: 1.8;
            color: #1a202c;
            background: #fff;
        }
        
        /* Vivliostyle用の設定 */
        html {
            orphans: 1;
            widows: 1;
        }
        
        /* ====================================
           タイトルページ（カバー）スタイル
           modern-vertical-coverベース
        ==================================== */
        .cover-page {
            page: title;
            width: 210mm;
            height: 297mm;
            position: relative;
            overflow: hidden;
            page-break-after: always;
            break-after: page;
        }
        
        /* 背景画像 */
        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        
        /* 縦書きテキストエリア */
        .text-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 100mm;
            height: 100%;
            z-index: 2;
            padding: 20mm 10mm 0 0;
            display: flex;
            writing-mode: vertical-rl;
            text-orientation: upright;
            justify-content: flex-start;
            align-items: flex-start;
        }
        
        /* タイトルセクション */
        .title-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .main-title {
            font-size: 120px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 30px;
            text-shadow: 
                1px 1px 0 #888888,
                -1px 1px 0 #888888,
                1px -1px 0 #888888,
                -1px -1px 0 #888888,
                0 1px 0 #888888,
                0 -1px 0 #888888,
                1px 0 0 #888888,
                -1px 0 0 #888888;
            writing-mode: vertical-rl;
            text-orientation: upright;
        }
        
        /* 印刷対応 */
        @media print {
            .cover-page {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .cover-image {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* ====================================
           見開きページスタイル（landscape-quote-spreadベース）
        ==================================== */
        .spread {
            page: spread;
            width: 420mm;
            height: 297mm;
            position: relative;
            display: flex;
            page-break-after: always;
            break-after: page;
            overflow: hidden;
        }
        
        /* 背景画像 - 見開き全体 */
        .spread-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: 100% auto;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 1;
        }
        
        /* 左ページ */
        .left-page {
            width: 210mm;
            height: 297mm;
            position: relative;
            z-index: 3;
        }
        
        /* 右ページ */
        .right-page {
            width: 210mm;
            height: 297mm;
            position: relative;
            z-index: 3;
        }
        
        .page-content {
            height: 100%;
            position: relative;
            padding: 35mm 25mm;
        }
        
        /* 縦書き格言コンテナ - 右上に配置 */
        .quote-container {
            position: absolute;
            top: 40mm;
            right: 35mm;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            width: auto;
            height: auto;
            max-height: 180mm;
        }
        
        /* 縦書きの格言 */
        .vertical-quote {
            font-size: 40px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.8;
            letter-spacing: 0.1em;
            text-shadow: 
                1px 1px 0 #888888,
                -1px 1px 0 #888888,
                1px -1px 0 #888888,
                -1px -1px 0 #888888,
                0 1px 0 #888888,
                0 -1px 0 #888888,
                1px 0 0 #888888,
                -1px 0 0 #888888;
            margin-bottom: 0px;
        }
        
        /* 著者名・タイトル */
        .quote-author {
            font-size: 32px;
            color: #ffffff;
            font-weight: 600;
            text-shadow: 
                1px 1px 0 #888888,
                -1px 1px 0 #888888,
                1px -1px 0 #888888,
                -1px -1px 0 #888888,
                0 1px 0 #888888,
                0 -1px 0 #888888,
                1px 0 0 #888888,
                -1px 0 0 #888888;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            margin-left: 20px;
        }
        
        /* 印刷対応 - 見開き */
        @media print {
            @page spread {
                size: 420mm 297mm;
                margin: 0;
            }
            
            html, body {
                page-break-inside: avoid;
                page-break-after: avoid;
            }
            
            .spread {
                width: 420mm !important;
                height: 297mm !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-inside: avoid;
                page-break-after: avoid;
                position: relative;
            }
            
            .left-page {
                width: 210mm !important;
                page-break-inside: avoid;
            }
            
            .right-page {
                width: 210mm !important;
                page-break-inside: avoid;
            }
            
            .spread-background-image {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* ====================================
           単一ページスタイル
           vertical-central-image-singleベース
        ==================================== */
        .single-page {
            page: single;
            width: 210mm;
            height: 297mm;
            position: relative;
            background: #fff;
            overflow: hidden;
            page-break-after: always;
            break-after: page;
        }
        
        .single-page.last-page {
            page-break-after: avoid;
            break-after: avoid;
        }
        
        .single-page-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 15mm;
        }
        
        /* 画像コンテナ - 上部約70% */
        .single-image-container {
            width: 100%;
            height: 70%;
            position: relative;
            margin-bottom: 0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 画像の柔軟な表示 */
        .page-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            object-position: center;
            display: block;
        }
        
        /* テキストコンテナ - 下部約30%に固定 */
        .text-container {
            height: 30%;
            padding-top: 4mm;
            overflow: hidden;
        }
        
        /* 縦書きテキストコンテナ */
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            padding-right: 0;
        }
        
        /* セクションタイトル */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 2mm;
            padding-bottom: 2mm;
            border-bottom: 2px solid #e2e8f0;
        }
        
        /* 縦書きセクションタイトル */
        .vertical-text .section-title {
            writing-mode: vertical-rl;
            text-orientation: upright;
            border-bottom: none;
            border-left: 2px solid #e2e8f0;
            padding-bottom: 0;
            padding-left: 2mm;
            margin-bottom: 0;
            margin-left: 3mm;
            margin-top: 0;
            display: inline-block;
        }
        
        /* 説明テキスト */
        .description-text {
            font-size: 14px;
            line-height: 1.7;
            color: #4a5568;
            text-align: justify;
            hyphens: auto;
        }
        
        /* 縦書き説明テキスト */
        .vertical-text .description-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            text-align: left;
            line-height: 2.0;
            font-size: 13px;
            display: inline-block;
            margin-left: 3mm;
        }
        
        /* 単一ページのフッター */
        .single-page-footer {
            position: absolute;
            bottom: 10mm;
            right: 15mm;
            z-index: 10;
        }
        
        .single-page-number {
            font-size: 12px;
            color: #a0aec0;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        /* 印刷対応 - 単一ページ */
        @media print {
            .single-page {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .page-image {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* 高解像度ディスプレイ対応 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .page-image {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }
        
        /* レスポンシブ対応（プレビュー時） */
        @media screen and (max-width: 1200px) {
            .cover-page, .single-page {
                transform: scale(0.8);
                transform-origin: top left;
            }
            
            .spread {
                transform: scale(0.7);
                transform-origin: top left;
            }
        }
        
        @media screen and (max-width: 900px) {
            .cover-page, .single-page {
                transform: scale(0.6);
                transform-origin: top left;
            }
            
            .spread {
                transform: scale(0.5);
                transform-origin: top left;
            }
        }
    </style>
</head>
<body>
    {% for page in pages %}
        {% if page.page_type == "title" %}
            {# タイトルページ（カバー） - modern-vertical-coverベース #}
            <div class="cover-page">
                <div class="background-image">
                    <img src="{{ page.data.cover_image }}" alt="Cover Image" class="cover-image">
                </div>
                <div class="text-area">
                    <div class="title-section">
                        <h1 class="main-title">{{ page.data.title }}</h1>
                    </div>
                </div>
            </div>
            
        {% elif page.page_type == "spread_image_text" %}
            {# 見開き画像+縦書きテキスト - landscape-quote-spreadベース #}
            <div class="spread">
                {# 背景画像 - 見開き全体 #}
                <div class="spread-background-image" style="background-image: url('{{ page.data.image }}');"></div>
                
                {# 左ページ - 画像の一部として使用 #}
                <div class="left-page">
                    <div class="page-content">
                        {# 左ページは基本的に画像の一部として使用 #}
                    </div>
                </div>
                
                {# 右ページ - 縦書きの格言 #}
                <div class="right-page">
                    <div class="page-content">
                        <div class="quote-container">
                            <blockquote class="vertical-quote">{{ page.data.story_text }}</blockquote>
                            {% if page.data.story_title %}
                            <cite class="quote-author">{{ page.data.story_title }}</cite>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
        {% elif page.page_type == "single_image_text" %}
            {# 単一ページ画像+テキスト - vertical-central-image-singleベース #}
            <div class="single-page{% if loop.last %} last-page{% endif %}">
                <div class="single-page-content">
                    <div class="single-image-container">
                        <img src="{{ page.data.image }}" alt="ページ画像" class="page-image">
                    </div>
                    <div class="text-container vertical-text">
                        {% if page.data.section_title %}
                        <h2 class="section-title">{{ page.data.section_title }}</h2>
                        {% endif %}
                        <div class="description-text">{{ page.data.description }}</div>
                    </div>
                </div>
                <footer class="single-page-footer">
                    <p class="single-page-number">{{ page.page_number }}</p>
                </footer>
            </div>
        {% endif %}
    {% endfor %}
</body>
</html>
